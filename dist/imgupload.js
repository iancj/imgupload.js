define(function(e,t,n){function a(e){this.$el=e,this.$preview=null,this.$dataset=null,this.$btn=null,this.uploaded=[],this.init()}function i(e,t){t=t?t:document;var n=t.querySelectorAll(e);return n}function l(e){return document.createElement(e)}function r(e,t){var n=t.parentNode;n.lastChild==t?n.appendChild(e):n.insertBefore(e,t.nextSibling)}function d(e,t){var n=i("#j-imguploadUrl")[0].value||"",a=new XMLHttpRequest,l=new FormData;a.open("POST",n,!0),a.onreadystatechange=function(){4==a.readyState&&200==a.status&&t&&t(a.responseText)},l.append("myFile",e),a.send(l)}a.prototype.init=function(){function e(e){var e;e="string"==typeof e?JSON.parse(e):e,e.succ&&t.addPreview(e.data.path)}var t=this;if(t.$el.addEventListener("change",function(){d(this.files[0],e)},!1),!t.$dataset){var n=l("input");n.type="hidden",n.name=t.$el.dataset.name,t.$dataset=n,r(t.$dataset,t.$el)}if(!t.$btn){var a=l("div");a.className="imgupload-btn",a.innerHTML="上传图片",t.$btn=a,r(t.$btn,t.$el),t.$el.style.display="none"}t.$btn.addEventListener("click",function(e){t.$el.click(),e.preventDefault()},!1)},a.prototype.addPreview=function(e){var t=this;if(!t.$preview){var n=l("ul");n.className="imgupload-preview",t.$preview=n,n.addEventListener("click",function(e){var a=Array.prototype.slice.call(i("li",n),0),l=e.target;a.forEach(function(e,a){l==e&&(n.removeChild(e),t.uploaded.splice(a,1),t.updateDataset())})},!1),r(t.$preview,t.$el.nextSibling)}var a=l("img"),d=l("li");a.src=e,d.appendChild(a),t.$preview.appendChild(d),t.uploaded.push(e),t.updateDataset()},a.prototype.updateDataset=function(){this.$dataset.value=this.uploaded.join(",")};for(var o=i(".j-imgupload"),p=0,s=o.length;s>p;p++)new a(o[p])});